name: Deploy to VPS

on:
    push:
        branches:
            - main # Trigger khi push l√™n branch main
    workflow_dispatch: # Cho ph√©p manual trigger t·ª´ GitHub UI

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to VPS via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  script: |
                      echo "üöÄ Starting deployment..."

                      # Navigate to project directory
                      cd /root/nova-be

                      # Pull latest code
                      echo "üì• Pulling latest code from GitHub..."
                      git pull origin main

                      # Load environment variables
                      echo "üîß Loading environment variables..."
                      set -a
                      source /root/.env.production
                      set +a

                      # Rebuild and restart backend container
                      echo "üê≥ Rebuilding Docker containers..."
                      cd /root
                      docker compose -f docker-compose.production.yml build --no-cache backend

                      echo "‚ôªÔ∏è  Restarting containers..."
                      docker compose -f docker-compose.production.yml up -d

                      # Wait for backend to be healthy
                      echo "‚è≥ Waiting for backend to start..."
                      sleep 10

                      # Check if backend is running
                      if docker ps | grep -q nova-backend-prod; then
                        echo "‚úÖ Deployment successful!"
                        echo "üåê Backend is running at http://167.71.210.47:4000"
                      else
                        echo "‚ùå Deployment failed! Backend is not running."
                        exit 1
                      fi

                      # Show logs (last 20 lines)
                      echo "üìã Recent logs:"
                      docker compose -f docker-compose.production.yml logs backend --tail=20
